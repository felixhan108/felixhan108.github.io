---
title: 디지털 앨범 만들기 Nginx + PhotoPrism + Swagger + Next.js
version: 0.0.1
latestUpdate: 2025-04-09
description: | 
	아이가 생기고 무수히 많은 사진과 비디오가 핸드폰에 쌓였습니다.
	GoogleDrive로 동기화 하며 써봤지만 Standard(200GB)가 넘으면 기분 나쁜 비용이 듭니다.
	집에 있는 1TB 하드디스크에 사진을 넣고 신규 사진을 매번 카카오톡으로 가족들과 주고 받기 보단 우리가족만의 디지털 사진첩을 만들고 싶어서 제작과 함께 글을 기록 합니다.
---

# 작업 순서

한눈에 들어오도록 작업의 순서를 나열 합니다.

1. `홈서버` 만들기
2. `Docker` 설치
3. `PhotoPrism` 설치
4. `Swagger` 연결
5. `Next.js` 설치

# 1.`홈서버` 만들기


## 홈서버 정보
https://sonapokets.day:2342/
가비아 -> 네이버 로그인
http://192.168.219.1/
http://192.168.219.102/

http://112.146.27.29/

https 해결을 위해 
Let's Encrypt로 무료 SSL 인증서 발급
Nginx/Caddy 리버스 프록시 설정

## 개발 과정
### 1. 포토프리즘 설치
### 2. nginx 및 Let's Encrypt 인증서 발급
nginx는 docker를 이용해 간단히 설치 함
```yml
nginx:
    image: nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./nginx/ssl:/etc/nginx/ssl
      - ./letsencrypt:/etc/letsencrypt
    depends_on:
      - photoprism
    networks:
      - photoprism-network
```
NginX 설정파일 생성
```bash
# 디렉토리 생성
mkdir -p ./nginx/conf.d
mkdir -p ./nginx/ssl
mkdir -p ./letsencrypt

# Nginx 설정 파일 생성
nano ./nginx/conf.d/photoprism.conf
```
```conf
# photoprism.conf 내용
server {
    listen 80;
    server_name yourdomain.com;

    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl;
    server_name yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;

    location / {
        proxy_pass http://photoprism:2342;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```
#### Lets' Encrypt 인증서 발급
Certbot 설치
```bash
# Certbot 설치
docker run --rm -it \
  -v $PWD/letsencrypt:/etc/letsencrypt \
  -v $PWD/letsencrypt-logs:/var/log/letsencrypt \
  -p 80:80 \
  certbot/certbot certonly --standalone \
  -d yourdomain.com \
  --agree-tos \
  --email your-email@example.com \
  --no-eff-email
```
시스템 재시작
```bash
docker-compose down
docker-compose up -d
```

### github actions 을 통한 CI/CD 구성


## 홈 서버 CI/CD 구성하기
### 깃헙 저장소 준비
### 필요파일 추가

### 깃헙 액션 워크플로우 파일 작성

### 배포 스크립트 작성

### 깃헙 시크릿 설정

### 서버측 준비

### SSH 키 설정
서버에 안전하게 접속하기 위한 암호화 키 쌍
비밀 키 : 내거
공개 키 : 서버에 등록하는 파일
### 주의사항 및 보안 강화
#### Let's Encrypt 인증서 자동 갱신 설정 추가
```yml
certbot:
    image: certbot/certbot
    volumes:
      - ./letsencrypt:/etc/letsencrypt
      - ./letsencrypt-logs:/var/log/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
```
#### 민감한 정보 분리
.env




## 홈서버 테스트
1. docker 로 서버 구축
2. 공인 ip + 포트포워딩 + ddns 셋팅
### docker로 구축할 서버
- 사진 서버
- 영상 서버
- 웹 서버
- ai 워커
### 첫번째 도커 '[사진서버]PhotoPrism' 설치
1.프로젝트 폴더 생성
2.docker-compose.yml 작성
```yml
version: "3"

services:
  photoprism:
    image: photoprism/photoprism
    restart: unless-stopped
    ports:
      - "2342:2342"
    environment:
      PHOTOPRISM_ADMIN_PASSWORD: "1234"
      PHOTOPRISM_UPLOAD_NSFW: "false"
    volumes:
      - ./photos:/photoprism/originals
      - ./photoprism-storage:/photoprism/storage
```
3.설치명령어 실행
```
docker compose up -d
```
4.api 확보방법
swagger 를 통한 서비스 
## 홈서버 구축 방법
http://192.168.219.1/ 접속
내부 192.168.219.102
90316579M!



정보
추가로 필요한 설정들:
a) 포트포워딩 설정
Apply to docker-compo...
)
b) DDNS 설정 (유동 IP 문제 해결)
Apply to docker-compo...
주기
보안 설정
Apply to docker-compo...
)
실제 설정 순서:
내부 서버에 고정 IP 할당
포트포워딩 설정
DDNS 설정
보안 설정
LG U+ 공유기에서:
192.168.219.1 접속
'고급설정' → '포트포워딩'
'고급설정' → 'DDNS'
이렇게 설정하면 외부에서도:
Apply to docker-compo...
2342
로 접속 가능합니다.
보안을 위해 기본 포트(2342)를 다른 번호로 변경하는 것을 추천드립니다.


## 개발 테스트
1. 로컬 서버 구축
2. Immich 서버 설치
3. Jellyfin 서버 설치
4. 사진 업로드 및 영상 업로드 api 테스트

## 홈서버 구축 방법
- 집에서 윈도우 PC에 Immich + Jellyfin 설치
    
- 공유기에서 포트포워딩 설정
    
- DuckDNS로 `myhome.duckdns.org` 같은 주소 받음
    
- 스마트폰 앱 설치 → 주소 입력 → 로그인
    
- 언제 어디서나 **사진과 영화 스트리밍 끝**
## 보안 + 외부 접속

- DDNS + HTTPS (Let’s Encrypt + reverse proxy)
    
- JWT 기반 인증
    
- 파일 전송은 HTTPS로 암호화

## 사진앱 ai 아키텍쳐
```cs
[모바일 앱]
   |
   | 사진 업로드 (파일 + 메타데이터)
   v
[홈서버 백엔드 (Spring + PostgreSQL)]
   |
   | 사진 저장 → DB 저장
   v
[얼굴인식 모듈 (Python + FaceNet or DeepFace)]
   |
   | 인물 태깅 → DB 저장
   v
[앱에서 "사람별 보기" 기능]
```

## 추천 조합 기술
|기능|기술 스택|
|---|---|
|백엔드|Java + Spring Boot (API 서버)|
|DB|PostgreSQL (사진, 메타데이터, 인물 테이블)|
|얼굴 인식|Python + DeepFace (REST API or 백그라운드 워커)|
|프론트|React Native or Flutter (모바일 앱)|
|서버 구성|Docker + docker-compose|
|파일 저장|`/photos` 디렉토리에 실제 이미지, DB에 경로만 저장|

## 앱에서 사진과 영상을 처리하는 html 매커니즘
### 1. **사진** 쪽

- API 직접 구현 (Spring) → 사진 불러오기, 업로드, 사람 필터 등
    
- PostgreSQL 기반 검색
    
- `https://서버주소/photos/파일명.jpg` 식으로 접근
    

### 2. **영상** 쪽

- Jellyfin의 API 호출하거나
    
- 또는 영상 파일을 HLS로 변환해서 `video.js` / `<Video>` 컴포넌트로 재생

```jsx
<Tabs>
  <Tab title="사진">
    <PhotoGalleryScreen />  // API 호출 + 그리드
  </Tab>
  <Tab title="영상">
    <VideoLibraryScreen />  // Jellyfin API or m3u8 리스트 보여주기
  </Tab>
</Tabs>
```

## 사진서버, 영상서버,  웹어플리케이션, 백엔드 서버 
| 항목  | 권장 방식                               |
| --- | ----------------------------------- |
| 사진  | 직접 API + PostgreSQL + 파일저장          |
| 영상  | Jellyfin 연결하거나, 직접 HLS 구성           |
| 앱   | 탭으로 분리 (사진/영상), 둘 다 REST API로 접근    |
| 서버  | 홈서버 1대로 가능 (Spring + DB + Jellyfin) |

## 사진 + 영상 모두 인물로 묶기

```sql
-- 인물 테이블
CREATE TABLE person (
  id SERIAL PRIMARY KEY,
  name TEXT
);

-- 미디어 테이블 (사진 + 영상 공통)
CREATE TABLE media (
  id SERIAL PRIMARY KEY,
  filename TEXT,
  media_type TEXT,        -- 'photo' or 'video'
  file_path TEXT,
  thumbnail_path TEXT,
  upload_time TIMESTAMP
);

-- 미디어-인물 관계 테이블
CREATE TABLE media_person (
  media_id INT REFERENCES media(id),
  person_id INT REFERENCES person(id)
);

```

## 얼굴 인식 방식

| 미디어      | 자동 얼굴 인식       | 방법                         |
| -------- | -------------- | -------------------------- |
| 사진       | **O (강력 지원)**  | DeepFace, FaceNet 등        |
| 영상       | **△ (가능하긴 함)** | 특정 프레임 추출 후 얼굴 인식          |
| 영상 수동 태깅 | **O**          | 사용자가 영상 업로드 시 “누가 나오는지” 선택 |
### 영상 얼굴인식 하기 프로세스
1. 영상 업로드
    
2. FFmpeg로 특정 시간대 프레임 추출 (예: 매 10초)
    
3. 추출한 이미지들에 얼굴 인식 수행

4. 인물 매칭 → 해당 `media_id`에 `person_id` 연결

## 홈서버 개발 순서
### 1단계: 로컬 개발 (Docker + 네트워크 테스트)

- Spring Boot API (사진/영상 업로드 + DB 저장)
    
- PostgreSQL (미디어/인물 메타데이터 저장)
    
- Python 얼굴 인식 모듈 (DeepFace or FaceNet)
    
- Jellyfin 또는 직접 만든 HLS 스트리밍 서버
    
- 파일 저장 디렉토리: `/media/photos`, `/media/videos`
    

### 2단계: 내부 네트워크 테스트

- 모바일 → 같은 와이파이 환경에서 접속 (`http://192.168.x.x:포트`)
    
- React Native 앱 or 웹에서 API 연동 확인
    

### 3단계: 외부 접속 테스트

- DDNS 설정 (예: DuckDNS)
    
- 포트 포워딩 설정 (예: 8096, 8080, 443 등)
    
- HTTPS 원하면: Let's Encrypt + Caddy or nginx proxy

## 개발순서
- **Next.js + Prisma 초기세팅**
- **사진 업로드 + DB 저장**
- **영상 업로드 + 스트리밍 (Jellyfin 연동 or 직접 m3u8)**
- **인물 등록 & 연결 UI/기능**
- **앱 연동 or PWA로 모바일 접근**
- **얼굴 인식 워커 (Python 따로 Docker로)**

## 스택구성
[Next.js App]
├── 프론트 (App Router, React UI)
├── API 라우트 (/api/...)
├── Prisma (ORM for PostgreSQL)
├── 파일 업로드 처리 (사진/영상)
└── 연동: 얼굴인식 워커 (Python 따로)
**Next.js 풀스택 + Prisma + PostgreSQL**로:
- 프론트/백을 하나로 유지하며 관리
- 사진/영상 파일 직접 처리 가능
- 인물 태깅, DB 연결도 직관적
- 모바일 앱 or 웹앱(PWA)도 확장 쉬움


## 홈서버에 필요한 서버 개 수
|역할|포트|비고|
|---|---|---|
|Next.js 앱|3000|프론트 + API 라우트 (사진/영상 업로드 포함)|
|PostgreSQL|5432|내부 연결용 (Prisma에서 사용)|
|Jellyfin (옵션)|8096|영상 스트리밍 서버 (연동 시)|

## 서버단의ai 작동
| 항목                     | 설명                                            |
| ---------------------- | --------------------------------------------- |
| **사진 업로드**             | Next.js API 라우트에서 처리 가능                       |
| **AI 사진 정리 (예: 얼굴인식)** | **별도 프로세스** (예: Python + AI모듈)로 분리해서 돌리는 게 좋아 |
| **Next.js에서 요청**       | 업로드 후, 백그라운드로 AI 워커에 요청 or 작업 큐에 등록           |
| **AI 처리 결과 저장**        | 인물 ID, 위치 정보 등은 DB에 저장돼서 Next.js에서 불러올 수 있음   |